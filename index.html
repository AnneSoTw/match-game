<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我們的配對遊戲 / Our Matchmaking Game</title>
    <script src="https://cdn.tailwindcss.com"></script> <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Merriweather:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* --- Inherited Bilingual Wedding Theme Styles --- */
        body {
            font-family: 'Merriweather', 'Noto Sans TC', serif;
            background: linear-gradient(to bottom, #f5f0e8, #e6dacb);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align top for potentially long content */
            min-height: 100vh;
            padding: 1rem;
            color: #5d4037;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            overscroll-behavior: none;
        }
        .game-container {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            width: 100%;
            max-width: 800px;
            text-align: center;
            border: 1px solid #d7ccc8;
            box-sizing: border-box;
        }
        .romantic-font {
            font-family: 'Dancing Script', 'Noto Sans TC', cursive;
            color: #8d6e63;
            line-height: 1.3; /* Adjust line height for script font */
        }
        /* Bilingual text styling - General */
        .lang-zh { display: block; font-weight: bold; margin-bottom: 0.15rem; font-family: 'Noto Sans TC', sans-serif; color: inherit; }
        .lang-en { display: block; font-size: 0.9em; color: inherit; }

        /* Bilingual styling for specific contexts */
        .bilingual-label .lang-zh { display: block; } /* Ensure block display for labels */
        .bilingual-label .lang-en { display: block; }
        #game-info .bilingual-label { display: inline-block; vertical-align: middle; margin-right: 0.3em; text-align: right; } /* Label part */
        #game-info .value { display: inline-block; vertical-align: middle; font-weight: bold; } /* Value part */


        .game-button {
            font-family: 'Merriweather', 'Noto Sans TC', serif; font-weight: bold;
            background-image: linear-gradient(to right, #d4af37, #c09b2d);
            color: white; padding: 0.8rem 1.8rem; border: none; border-radius: 2rem;
            cursor: pointer; transition: all 0.3s ease; text-transform: uppercase;
            letter-spacing: 1px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-top: 1.5rem; display: inline-block; line-height: 1.4;
        }
        .game-button .lang-zh { color: white; }
        .game-button .lang-en { color: white; font-size: 0.8em; }
        .game-button:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); filter: brightness(1.05); }
        .game-button:active { transform: translateY(0); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .game-button:disabled {
            background-image: none;
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.7;
        }


        /* Input fields */
        input[type="text"], input[type="email"] {
            font-family: 'Merriweather', 'Noto Sans TC', serif;
            border: 1px solid #d7ccc8; border-radius: 0.5rem;
            color: #5d4037;
            padding: 10px;
            margin: 10px 0;
            width: calc(100% - 22px); /* Adjust width */
            box-sizing: border-box;
        }
        input[type="text"]:focus, input[type="email"]:focus {
             border-color: #d4af37; box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
             outline: none;
        }
        /* Page visibility */
        .page { display: none; }
        .page.active { display: block; }
        .hidden { display: none !important; }

        /* --- Match Game Specific Styles --- */
        #game-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            font-family: 'Merriweather', 'Noto Sans TC', serif;
            font-weight: bold;
            color: #8d6e63;
            font-size: 0.9rem;
            align-items: center; /* Vertically align items */
        }
        #game-info > div {
            background-color: #f5f5f5;
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            border: 1px solid #e0e0e0;
            line-height: 1.2; /* Adjust line height for stacked labels */
        }


        .game-content {
             display: flex;
             flex-direction: column;
             gap: 20px;
             margin-top: 20px;
        }

        .drag-item-container {
            position: relative;
            width: 100%;
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
        }

        .drag-item {
            width: 100px;
            height: 100px;
            background-color: #eee;
            border-radius: 10px;
            cursor: grab;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8em;
            color: #555;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            draggable: false;
            transition: transform 0.1s ease-out, opacity 0.3s ease;
            touch-action: none;
            position: relative;
            z-index: 1;
        }

         .drag-item.dragging {
             position: fixed;
             z-index: 1000;
             cursor: grabbing;
             opacity: 0.7;
             transition: none;
             /* left/top set dynamically in JS */
         }

        .drag-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
            pointer-events: none;
        }

        .drop-columns-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }

        .drop-column {
            flex: 1;
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 15px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 10px;
            transition: border-color 0.3s ease, background-color 0.3s ease;
            max-height: 40vh;
        }

        .drop-column.drag-over {
            border-color: #a1887f;
            background-color: #f5f0e8;
        }

        .column-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #5a3e36;
            flex-shrink: 0;
            align-self: center;
            line-height: 1.4;
        }
        .column-title .lang-en { font-size: 0.9em; }

        .dropped-items-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            width: 100%;
            align-items: flex-start;
            min-height: 80px;
            overflow-y: auto;
            max-height: calc(40vh - 60px);
            padding-bottom: 5px;
        }

        .dropped-item {
             width: 60px;
             height: 60px;
             border-radius: 8px;
             overflow: hidden;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
             flex-shrink: 0;
        }

         .dropped-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        /* Award Certificate & Social Share Styles */
        .award-certificate { border: 8px double #c09b2d; padding: 2rem; margin-top: 2.5rem; background-color: #fffaf0; border-radius: 0.5rem; position: relative; text-align: center; }
        .award-title { font-family: 'Dancing Script', 'Noto Sans TC', cursive; color: #a1887f; font-size: 2rem; margin-bottom: 1.5rem; line-height: 1.3; }
        .award-text { color: #795548; font-size: 1rem; line-height: 1.7; margin-bottom: 1.5rem; }
        .award-text .lang-zh, .award-text .lang-en { color: inherit; }
        .award-text strong { font-weight: bold; color: #8d6e63; }
        .award-logo { display: block; width: 80px; height: 80px; margin: 1.5rem auto 1rem auto; border-radius: 0.25rem; object-fit: contain; }
        .save-the-date-text { margin-top: 0.75rem; font-size: 0.9rem; color: #a1887f; font-weight: bold; line-height: 1.4; }
        .save-the-date-text .lang-zh, .save-the-date-text .lang-en { color: inherit; }
        .social-share-section { margin-top: 2rem; }
        .social-share-text { font-size: 0.9rem; color: #a1887f; font-weight: bold; margin-bottom: 0.75rem; line-height: 1.4; }
        .social-share-text .lang-zh, .social-share-text .lang-en { color: inherit; }
        .social-icon-link { display: inline-block; transition: opacity 0.3s ease; }
        .social-icon-link:hover { opacity: 0.8; }
        .social-icon-link svg { width: 36px; height: 36px; }
        #email-status { margin-top: 1.5rem; margin-bottom: 1rem; font-size: 0.9rem; font-weight: bold; line-height: 1.4; }
        #email-status .lang-zh, #email-status .lang-en { color: inherit; }
        .email-success { color: #388e3c; }
        .email-error { color: #c62828; }
        .email-sending { color: #6d4c41; }

        /* UPDATED: Style for the temporary share canvas wrapper (9:16 aspect ratio) */
        .share-canvas-wrapper {
            position: absolute;
            left: -9999px; /* Position off-screen */
            top: -9999px;
            width: 540px;  /* Base width for 9:16 aspect ratio */
            height: 960px; /* Base height for 9:16 aspect ratio */
            display: flex;
            flex-direction: column;
            justify-content: center; /* Center certificate vertically in wrapper */
            align-items: center; /* Center certificate horizontally in wrapper */
            background-color: #fffaf0; /* Match certificate background */
            padding: 20px; /* Reduced padding around the certificate content */
            box-sizing: border-box;
            overflow: hidden; /* Clip content to these dimensions */
        }
         /* UPDATED: Styles for the cloned certificate *inside* the share wrapper */
         .share-canvas-wrapper .award-certificate {
             border: 6px double #c09b2d; /* Slightly thinner border */
             box-shadow: none;
             padding: 1rem; /* Reduced padding inside the certificate */
             width: 100%; 
             height: 100%; 
             max-width: 100%;
             margin: 0;
             display: flex;
             flex-direction: column;
             justify-content: space-between; /* Distribute space: title, text, bottom */
             align-items: center;
             text-align: center;
             box-sizing: border-box;
             background-color: #fffaf0; 
         }
         /* UPDATED: Adjust font sizes and margins within the cloned certificate for story format */
         .share-canvas-wrapper .award-title {
             font-size: 1.6rem; /* Reduced title font size */
             margin-bottom: 0.8rem; /* Reduced margin */
             line-height: 1.2;
         }
         .share-canvas-wrapper .award-text {
             font-size: 0.8rem; /* Reduced body text font size */
             line-height: 1.35; /* Reduced line height */
             margin-bottom: 0.8rem; /* Reduced margin */
             overflow: hidden; /* Hide text overflow if it's still too much */
             max-height: 50%; /* Attempt to constrain text block height */
         }
         .share-canvas-wrapper .award-text strong {
             font-size: 0.85rem; /* Adjust strong text size */
         }
         /* UPDATED: Container for logo and save the date at the bottom of the story image */
         .share-canvas-wrapper .bottom-section {
             display: flex;
             justify-content: space-between;
             align-items: flex-end; 
             width: 100%;
             margin-top: auto; /* Push this section to the bottom */
             padding: 0 0.25rem; /* Reduced horizontal padding */
             box-sizing: border-box;
             flex-shrink: 0; /* Prevent this section from shrinking */
         }

         .share-canvas-wrapper .award-logo {
             width: 50px; /* Reduced logo size */
             height: 50px;
             margin: 0; 
             order: 2; 
             object-fit: contain;
             flex-shrink: 0; /* Prevent logo from shrinking */
         }
         .share-canvas-wrapper .save-the-date-text {
             font-size: 0.7rem; /* Reduced save the date text size */
             color: #795548; 
             font-weight: normal; 
             line-height: 1.15; /* Reduced line height */
             margin: 0; 
             text-align: left; 
             order: 1; 
             flex-grow: 1; 
             padding-right: 0.25rem; /* Reduced space */
         }


        /* Desktop Responsiveness */
        @media (min-width: 768px) {
            .game-content {
                flex-direction: row;
                align-items: flex-start;
            }
            .drag-item-container {
                 width: 150px;
                 height: auto;
                 margin-bottom: 0;
                 margin-right: 20px;
                 align-self: center;
            }
             .drop-columns-container {
                 flex-grow: 1;
                 flex-direction: row;
                 gap: 20px;
             }
             .drop-column {
                 min-height: 300px;
                 max-height: 60vh;
                 padding: 20px;
             }
             .dropped-items-container {
                 justify-content: flex-start;
                 max-height: calc(60vh - 70px);
                 min-height: 100px;
             }
             .dropped-item {
                 width: 70px;
                 height: 70px;
             }
        }

    </style>
</head>
<body>

    <div class="game-container">

        <div id="welcome-screen" class="page active">
            <h1 class="text-4xl font-bold mb-6 romantic-font">
                <span class="lang-zh">歡迎來玩配對遊戲！</span>
                <span class="lang-en">Welcome to the Match Game! B</span>
            </h1>
            <p class="mb-5 text-gray-600" style="line-height: 1.6;">
                <span class="lang-zh">遊戲規則：<br>1. 輸入您的姓名和電子郵件。<br>2. 將物品拖曳到屬於新郎或新娘的欄位。<br>3. 完成後查看您的分數和時間。<br>4. 結果將自動發送給我們。</span>
                <span class="lang-en">How to play:<br>1. Enter your name and email.<br>2. Drag items to the Groom's or Bride's column.<br>3. See your score and time at the end.<br>4. Results will be sent automatically.</span>
            </p>
            <button id="continue-button" class="game-button">
                <span class="lang-zh">繼續</span>
                <span class="lang-en">Continue</span>
            </button>
        </div>

        <div id="start-screen" class="page hidden">
            <h1 class="text-4xl font-bold mb-6 romantic-font">
                 <span class="lang-zh">輸入您的資料</span>
                 <span class="lang-en">Enter Your Details</span>
            </h1>
            <p class="mb-5 text-gray-600">
                <span class="lang-zh">請輸入您的姓名和電子郵件以開始：</span>
                <span class="lang-en">Please enter your name and email to start:</span>
            </p>
            <input type="text" id="nickname" placeholder="Your Name / 您的姓名" class="w-full p-3 border rounded-lg mb-3 focus:outline-none" required>
            <input type="email" id="email" placeholder="Your Email / 您的電子郵件" class="w-full p-3 border rounded-lg mb-4 focus:outline-none" required>
            <button id="start-game-button" class="game-button">
                <span class="lang-zh">開始遊戲</span>
                <span class="lang-en">Start Game</span>
            </button>
            <p id="start-error" class="text-red-600 mt-3 text-sm"></p>
        </div>

        <div id="game-screen" class="page hidden">
            <h1 class="text-3xl font-bold mb-4 romantic-font">
                <span class="lang-zh">這是誰的？</span>
                <span class="lang-en">Whose is This?</span>
            </h1>
            <div id="game-info">
                <div id="items-left-counter">
                    <span class="bilingual-label">
                        <span class="lang-zh">剩餘物品:</span>
                        <span class="lang-en">Items Left:</span>
                    </span>
                    <span class="value">0</span>
                </div>
                <div id="timer-display">
                     <span class="bilingual-label">
                        <span class="lang-zh">時間:</span>
                        <span class="lang-en">Time:</span>
                    </span>
                    <span class="value">0s</span>
                </div>
            </div>
            <div class="game-content">
                <div class="drag-item-container">
                     <div id="currentPicture" class="drag-item">
                        </div>
                </div>
                <div class="drop-columns-container">
                    <div id="groomColumn" class="drop-column" data-owner="groom">
                        <div class="column-title">
                            <span class="lang-zh">新郎</span>
                            <span class="lang-en">Groom</span>
                        </div>
                        <div class="dropped-items-container"></div>
                    </div>
                    <div id="brideColumn" class="drop-column" data-owner="bride">
                         <div class="column-title">
                             <span class="lang-zh">新娘</span>
                             <span class="lang-en">Bride</span>
                         </div>
                         <div class="dropped-items-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="results-screen" class="page hidden">
            <h1 class="text-4xl font-bold mb-5 romantic-font">
                 <span class="lang-zh">遊戲完成！</span>
                 <span class="lang-en">Game Complete!</span>
             </h1>

            <div id="email-status"></div>

            <div class="award-certificate">
                 <div class="award-title">
                     <span class="lang-zh">配對大師證書</span>
                     <span class="lang-en">Certificate of Matchmaking!</span>
                 </div>
                 <div class="award-text">
                      <span class="lang-zh">謹將此證書頒發給<br><strong id="award-nickname-zh" class="text-lg"></strong><br>感謝您與我們一同慶祝並完成配對遊戲<br>日期：<span id="completion-date-zh"></span><br>分數：<strong id="award-score-zh"></strong>，時間：<strong id="award-time-zh"></strong> 秒</span>
                     <span class="lang-en">This certificate is happily presented to<br><strong id="award-nickname-en" class="text-lg"></strong><br>for celebrating with us and completing the Match Game on <span id="completion-date-en"></span><br>with a score of <strong id="award-score-en"></strong> and a time of <strong id="award-time-en"></strong> seconds.</span>
                 </div>
                 <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b3/Seal_of_the_United_States_Marine_Corps.svg/1012px-Seal_of_the_United_States_Marine_Corps.svg.png" alt="Logo Placeholder" class="award-logo" id="award-logo">
                 <p class="save-the-date-text">
                    <span class="lang-zh">MAS - 敬請期待 2222/02/02</span>
                    <span class="lang-en">MAS - Save the date 2222/02/02</span>
                 </p>
            </div>

            <div class="social-share-section">
                <p class="social-share-text">
                    <span class="lang-zh" id="share-text-zh">在社交媒體上分享</span>
                    <span class="lang-en" id="share-text-en">Share on social media</span>
                </p>
                <a href="#" id="instagram-share-link" rel="noopener noreferrer" class="social-icon-link" aria-label="Share on Instagram">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="36px" height="36px">
                        <defs>
                            <linearGradient id="ig-grad" x1="0%" y1="100%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#FFD600;stop-opacity:1" />
                                <stop offset="25%" style="stop-color:#FF7A00;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#D300C5;stop-opacity:1" />
                                <stop offset="75%" style="stop-color:#7638FA;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#448AFF;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <path fill="url(#ig-grad)" d="M 16 4 C 11.81 4 11.44 4.01 10.15 4.07 C 6.37 4.25 4.25 6.37 4.07 10.15 C 4.01 11.44 4 11.81 4 16 C 4 20.19 4.01 20.56 4.07 21.85 C 4.25 25.63 6.37 27.75 10.15 27.93 C 11.44 27.99 11.81 28 16 28 C 20.19 28 20.56 27.99 21.85 27.93 C 25.63 27.75 27.75 25.63 27.93 21.85 C 27.99 20.56 28 20.19 28 16 C 28 11.81 27.99 11.44 27.93 10.15 C 27.75 6.37 25.63 4.25 21.85 4.07 C 20.56 4.01 20.19 4 16 4 Z M 16 6 C 20.06 6 20.4 6.01 21.6 6.07 C 24.51 6.21 25.79 7.49 25.93 10.4 C 25.99 11.6 26 11.94 26 16 C 26 20.06 25.99 20.4 25.93 21.6 C 25.79 24.51 24.51 25.79 21.6 25.93 C 20.4 25.99 20.06 26 16 26 C 11.94 26 11.6 25.99 10.4 25.93 C 7.49 25.79 6.21 24.51 6.07 21.6 C 6.01 20.4 6 20.06 6 16 C 6 11.94 6.01 11.6 6.07 10.4 C 6.21 7.49 7.49 6.21 10.4 6.07 C 11.6 6.01 11.94 6 16 6 Z M 16 10 C 12.69 10 10 12.69 10 16 C 10 19.31 12.69 22 16 22 C 19.31 22 22 19.31 22 16 C 22 12.69 19.31 10 16 10 Z M 16 12 C 18.21 12 20 13.79 20 16 C 20 18.21 18.21 20 16 20 C 13.79 20 12 18.21 12 16 C 12 13.79 13.79 12 16 12 Z M 21.5 7.5 A 1.5 1.5 0 0 0 20 9 A 1.5 1.5 0 0 0 21.5 10.5 A 1.5 1.5 0 0 0 23 9 A 1.5 1.5 0 0 0 21.5 7.5 Z"/>
                    </svg>
                </a>
            </div>
             <button id="replay-button" class="game-button hidden" style="margin-top: 1rem;">
                 <span class="lang-zh">再玩一次</span>
                 <span class="lang-en">Play Again</span>
             </button>

         </div>

    </div>


    <script>
        // --- EmailJS Configuration ---
  const EMAILJS_SERVICE_ID = 'service_3qozdwc';
        const EMAILJS_TEMPLATE_ID = 'template_q69067c';
        const EMAILJS_PUBLIC_KEY = 'cDxOmMxePGWSWrLPG';

        // --- Bilingual Text Content ---
        const TEXT_CONTENT = {
            emailSending: { zh: "正在發送結果...", en: "Sending results..." },
            emailSuccess: { zh: "結果發送成功！", en: "Results sent successfully!" },
            emailErrorConfig: { zh: "無法發送結果。請檢查配置。", en: "Failed to send results. Please check configuration." },
            emailErrorTemplate: { zh: "無法發送結果。請檢查 EmailJS 模板參數。", en: "Failed to send results. Check EmailJS template parameters." },
            emailErrorGeneric: { zh: "無法發送結果。請稍後再試。", en: "Failed to send results. Please try again later." },
            emailNotConfigured: { zh: "電子郵件發送未配置。", en: "Email sending not configured." },
            errorEnterDetails: { zh: "請輸入您的姓名和電子郵件。", en: "Please enter both your name and email." },
            errorInvalidEmail: { zh: "請輸入有效的電子郵件地址。", en: "Please enter a valid email address." },
            shareText: { zh: "在社交媒體上分享", en: "Share on social media" },
            loadingText: { zh: "載入中...", en: "Loading..." },
            loadingPhotosError: { zh: "載入圖片失敗。請檢查圖片來源和清單檔案。", en: "Failed to load photos. Please check photo sources and manifest files." },
            loadingPhotos: { zh: "載入圖片中...", en: "Loading photos..." },
            shareUnsupported: { zh: "您的瀏覽器不支援直接分享圖片。請嘗試截圖。", en: "Direct image sharing is not supported in your browser. Please try taking a screenshot." },
            shareFailed: { zh: "分享失敗。請稍後再試。", en: "Sharing failed. Please try again later." },
            shareHtml2CanvasError: { zh: "無法準備分享圖片。請稍後再試。", en: "Could not prepare image for sharing. Please try again later." }
        };

        // --- Game Configuration ---
        const BRIDE_MANIFEST_URL = 'https://raw.githubusercontent.com/AnneSoTw/match-game/refs/heads/main/bride_photo.json';
        const GROOM_MANIFEST_URL = 'https://raw.githubusercontent.com/AnneSoTw/match-game/refs/heads/main/groom_photo.json';

        const picturesPerGame = 10;
        // Ensure this logoImage is a valid URL or a data URI that html2canvas can access.
        // If it's a relative path on your server, ensure it's accessible.
        // For testing, a full external URL or a data URI is often more reliable.
        const logoImage = document.getElementById('award-logo') ? document.getElementById('award-logo').src : 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIi polarised="45" fill="#a08075"/><text x="50" y="55" font-family="Arial" font-size="30" fill="#ffffff" text-anchor="middle">LOGO</text></svg>';


        // --- DOM Elements ---
        const welcomeScreen = document.getElementById('welcome-screen');
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const resultsScreen = document.getElementById('results-screen');
        const continueButton = document.getElementById('continue-button');
        const startGameButton = document.getElementById('start-game-button');
        const replayButton = document.getElementById('replay-button');
        const nicknameInput = document.getElementById('nickname');
        const emailInput = document.getElementById('email');
        const startError = document.getElementById('start-error');
        const itemsLeftCounter = document.getElementById('items-left-counter');
        const timerDisplay = document.getElementById('timer-display');
        const currentPictureElement = document.getElementById('currentPicture');
        const groomColumn = document.getElementById('groomColumn');
        const brideColumn = document.getElementById('brideColumn');
        const emailStatusEl = document.getElementById('email-status');
        const awardNicknameZh = document.getElementById('award-nickname-zh');
        const awardNicknameEn = document.getElementById('award-nickname-en');
        const completionDateZh = document.getElementById('completion-date-zh');
        const completionDateEn = document.getElementById('completion-date-en');
        const awardScoreZh = document.getElementById('award-score-zh');
        const awardScoreEn = document.getElementById('award-score-en');
        const awardTimeZh = document.getElementById('award-time-zh');
        const awardTimeEn = document.getElementById('award-time-en');
        const shareTextZh = document.getElementById('share-text-zh');
        const shareTextEn = document.getElementById('share-text-en');
        const awardLogoElementOnPage = document.getElementById('award-logo'); // Reference to the logo img on the results page
        const instagramShareLink = document.getElementById('instagram-share-link');
        const awardCertificateElement = document.querySelector('.award-certificate'); 

        // --- Game State Variables ---
        let userNickname = '';
        let userEmail = '';
        let score = 0;
        let timerInterval = null;
        let startTime;
        let secondsElapsed = 0;
        let currentPictureIndex = 0;
        let allPictures = [];
        let gamePictures = [];
        let isDragging = false;
        let dragOffsetX, dragOffsetY;
        // Removed initialElementLeft, initialElementTop as they were not used.

        // --- Functions ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
                page.classList.remove('active');
            });
            const pageToShow = document.getElementById(pageId);
            if (pageToShow) {
                pageToShow.classList.remove('hidden');
                pageToShow.classList.add('active');
            } else {
                console.error("Page not found:", pageId);
            }
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function selectRandomPictures(arr, num) {
            const shuffled = shuffle([...arr]);
            const count = Math.min(num, shuffled.length);
            return shuffled.slice(0, count);
        }

        async function fetchPhotoManifests(brideManifestUrl, groomManifestUrl) {
            try {
                startError.innerHTML = `<span class="lang-zh">${TEXT_CONTENT.loadingPhotos.zh}</span><span class="lang-en">${TEXT_CONTENT.loadingPhotos.en}</span>`;
                startError.classList.remove('text-red-600');
                startError.classList.add('text-gray-600');

                const [brideResponse, groomResponse] = await Promise.all([
                    fetch(brideManifestUrl),
                    fetch(groomManifestUrl)
                ]);

                if (!brideResponse.ok) throw new Error(`HTTP error fetching bride manifest! status: ${brideResponse.status}`);
                if (!groomResponse.ok) throw new Error(`HTTP error fetching groom manifest! status: ${groomResponse.status}`);

                const brideUrls = await brideResponse.json();
                const groomUrls = await groomResponse.json();

                if (!Array.isArray(brideUrls) || brideUrls.some(item => typeof item !== 'string' || !item.startsWith('http'))) {
                    throw new Error("Invalid bride manifest format.");
                }
                if (!Array.isArray(groomUrls) || groomUrls.some(item => typeof item !== 'string' || !item.startsWith('http'))) {
                    throw new Error("Invalid groom manifest format.");
                }

                const bridePictures = brideUrls.map(url => ({ url: url, owner: 'bride' }));
                const groomPictures = groomUrls.map(url => ({ url: url, owner: 'groom' }));
                allPictures = [...bridePictures, ...groomPictures];
                startError.innerHTML = '';
                startError.classList.remove('text-gray-600');
            } catch (error) {
                console.error("Error fetching photo manifests:", error);
                allPictures = [];
                startError.innerHTML = `<span class="lang-zh">${TEXT_CONTENT.loadingPhotosError.zh}</span><span class="lang-en">${TEXT_CONTENT.loadingPhotosError.en}</span>`;
                startError.classList.remove('text-gray-600');
                startError.classList.add('text-red-600');
                startGameButton.disabled = true;
            }
        }
        
        function startTimer() {
            stopTimer();
            startTime = Date.now();
            secondsElapsed = 0;
            updateTimerDisplay();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
        }

        function updateTimer() {
            secondsElapsed = Math.floor((Date.now() - startTime) / 1000);
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            timerDisplay.innerHTML = `
                <span class="bilingual-label">
                    <span class="lang-zh">時間:</span><span class="lang-en">Time:</span>
                </span>
                <span class="value">${secondsElapsed}s</span>`;
        }

        function updateItemsLeft() {
            const itemsRemaining = gamePictures.length - currentPictureIndex;
            itemsLeftCounter.innerHTML = `
                <span class="bilingual-label">
                    <span class="lang-zh">剩餘物品:</span><span class="lang-en">Items Left:</span>
                </span>
                <span class="value">${itemsRemaining >= 0 ? itemsRemaining : 0}</span>`;
        }

        function loadNextPicture() {
            currentPictureElement.style.opacity = 1;
            currentPictureElement.style.position = 'relative';
            currentPictureElement.style.left = 'auto';
            currentPictureElement.style.top = 'auto';
            currentPictureElement.style.transform = 'none';
            currentPictureElement.draggable = false;
            currentPictureElement.removeAttribute('data-owner');
            currentPictureElement.classList.remove('dragging');
            currentPictureElement.innerHTML = '';

            if (currentPictureIndex < gamePictures.length) {
                updateItemsLeft();
                const picture = gamePictures[currentPictureIndex];
                
                const loadingImg = document.createElement('img');
                loadingImg.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNDUiIGZpbGw9IiNlMGUwZTAiLz48dGV4dCB4PSI1MCIgeT0iNTUuMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE4IiBmaWxsPSIjMDAwMDAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5Mb2FkaW5nLi4uPC90ZXh0Pjwvc3ZnPg==';
                loadingImg.alt = 'Loading...';
                currentPictureElement.appendChild(loadingImg);

                const img = document.createElement('img');
                img.onload = () => {
                    if (currentPictureIndex < gamePictures.length && gamePictures[currentPictureIndex].url === img.src) {
                        currentPictureElement.innerHTML = '';
                        currentPictureElement.appendChild(img);
                        currentPictureElement.setAttribute('data-owner', picture.owner);
                        currentPictureElement.draggable = true;
                    }
                };
                img.onerror = () => {
                    if (currentPictureIndex < gamePictures.length && gamePictures[currentPictureIndex].url === picture.url) {
                        const errorImg = document.createElement('img');
                        errorImg.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNjYzI4MjgiLz48dGV4dCB4PSI1MCIgeT0iNTUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iI2ZmZmZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+RXJyb3I8L3RleHQ+PC9zdmc+';
                        errorImg.alt = 'Error';
                        currentPictureElement.innerHTML = '';
                        currentPictureElement.appendChild(errorImg);
                        currentPictureIndex++;
                        setTimeout(loadNextPicture, 500);
                    }
                };
                img.src = picture.url;
                img.alt = "Item to match";
            } else {
                updateItemsLeft();
                endGame();
            }
        }

        function handleDrop(draggedElement, dropTarget, draggedOwner, targetOwner) {
            const pictureImgElement = draggedElement.querySelector('img');
            const pictureUrl = pictureImgElement ? pictureImgElement.src : '';

            const droppedItem = document.createElement('div');
            droppedItem.classList.add('dropped-item');
            if (pictureImgElement) {
                const droppedImg = document.createElement('img');
                droppedImg.src = pictureUrl;
                droppedImg.alt = "Dropped Item";
                droppedItem.appendChild(droppedImg);
            } else {
                droppedItem.textContent = 'Error';
            }

            const droppedItemsContainer = dropTarget.querySelector('.dropped-items-container');
            if (droppedItemsContainer) {
                droppedItemsContainer.appendChild(droppedItem);
            } else {
                dropTarget.appendChild(droppedItem);
            }

            if (draggedOwner === targetOwner) {
                score++;
            }

            draggedElement.style.transition = 'opacity 0.2s ease-out';
            draggedElement.style.opacity = 0;

            currentPictureIndex++;
            setTimeout(() => {
                loadNextPicture();
            }, 200);
        }

        function endGame() {
            stopTimer();
            const finalScoreText = `${score} / ${gamePictures.length}`;
            const today = new Date();
            const dateZh = today.toLocaleDateString('zh-TW');
            const dateEn = today.toLocaleDateString('en-US');

            awardNicknameZh.textContent = userNickname;
            awardNicknameEn.textContent = userNickname;
            completionDateZh.textContent = dateZh;
            completionDateEn.textContent = dateEn;
            awardScoreZh.textContent = finalScoreText;
            awardScoreEn.textContent = finalScoreText;
            awardTimeZh.textContent = secondsElapsed;
            awardTimeEn.textContent = secondsElapsed;
            shareTextZh.textContent = TEXT_CONTENT.shareText.zh;
            shareTextEn.textContent = TEXT_CONTENT.shareText.en;
            
            // Ensure the main page logo is set using its ID
            if (awardLogoElementOnPage) {
                 awardLogoElementOnPage.src = logoImage; // Use the global logoImage variable
            }


            showPage('results-screen');
            replayButton.classList.remove('hidden');
            sendResultsEmail();
        }

        function setEmailStatus(statusKey) {
             const status = TEXT_CONTENT[statusKey];
             let className = 'email-sending';
             if (statusKey === 'emailSuccess') className = 'email-success';
             if (statusKey.startsWith('emailError') || statusKey === 'emailNotConfigured') className = 'email-error';

             if (emailStatusEl) {
                emailStatusEl.innerHTML = `<span class="lang-zh">${status.zh}</span><span class="lang-en">${status.en}</span>`;
                emailStatusEl.className = className;
             }
         }

        function sendResultsEmail() {
            if (!EMAILJS_SERVICE_ID || EMAILJS_SERVICE_ID === 'YOUR_SERVICE_ID' ||
                !EMAILJS_TEMPLATE_ID || EMAILJS_TEMPLATE_ID === 'YOUR_TEMPLATE_ID' ||
                !EMAILJS_PUBLIC_KEY || EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY') {
                setEmailStatus('emailNotConfigured');
                return;
            }
            setEmailStatus('emailSending');
            const templateParams = {
                nickname: userNickname,
                email: userEmail,
                score: `${score} / ${gamePictures.length}`,
                time: secondsElapsed,
                game_type: 'Match Game'
            };
            emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
                .then(() => setEmailStatus('emailSuccess'), (error) => {
                   let errorKey = 'emailErrorGeneric';
                   if (error && error.status === 400) errorKey = 'emailErrorTemplate';
                   else if (error && error.status !== 0) errorKey = 'emailErrorConfig';
                   setEmailStatus(errorKey);
                });
        }

        // MODIFIED: shareCertificate function
        async function shareCertificate() {
            console.log("Attempting to share certificate for story...");
            if (!awardCertificateElement) {
                console.error("Award certificate element not found.");
                alert(TEXT_CONTENT.shareFailed.zh + '\n' + TEXT_CONTENT.shareFailed.en);
                return;
            }

            let tempWrapper = null; 
            try {
                tempWrapper = document.createElement('div');
                tempWrapper.classList.add('share-canvas-wrapper'); 

                const certificateClone = awardCertificateElement.cloneNode(true);
                
                // Get the source of the logo currently displayed on the page
                const currentLogoSrc = awardLogoElementOnPage ? awardLogoElementOnPage.src : logoImage; // Fallback to global logoImage
                const clonedLogoImg = certificateClone.querySelector('.award-logo');
                if(clonedLogoImg) {
                    clonedLogoImg.src = currentLogoSrc; // Set the cloned logo's src
                }


                const clonedSaveTheDate = certificateClone.querySelector('.save-the-date-text');
                const bottomSection = document.createElement('div');
                bottomSection.classList.add('bottom-section'); 

                if (clonedSaveTheDate && clonedSaveTheDate.parentNode) {
                    clonedSaveTheDate.parentNode.removeChild(clonedSaveTheDate); 
                    bottomSection.appendChild(clonedSaveTheDate); 
                }
                if (clonedLogoImg && clonedLogoImg.parentNode) {
                    clonedLogoImg.parentNode.removeChild(clonedLogoImg); 
                    bottomSection.appendChild(clonedLogoImg); 
                }

                certificateClone.appendChild(bottomSection);
                tempWrapper.appendChild(certificateClone);
                document.body.appendChild(tempWrapper);
                console.log("Temporary share wrapper created and added to DOM (off-screen).");

                const canvas = await html2canvas(tempWrapper, {
                    scale: 3, 
                    logging: true, 
                    useCORS: true, 
                    backgroundColor: null 
                });
                console.log("Certificate rendered to canvas using tempWrapper for story.");

                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        console.error("Failed to create blob from canvas.");
                        alert(TEXT_CONTENT.shareFailed.zh + '\n' + TEXT_CONTENT.shareFailed.en);
                        return;
                    }

                    const file = new File([blob], 'match_game_certificate.png', { type: 'image/png' });
                    console.log("Blob converted to File:", file);

                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        try {
                            console.log("Web Share API supported. Sharing file...");
                            await navigator.share({
                                files: [file],
                                title: 'Our Matchmaking Game Certificate!',
                            });
                            console.log("Certificate shared successfully via Web Share API.");
                        } catch (shareError) {
                            console.error("Web Share failed:", shareError);
                            if (shareError.name !== 'AbortError') { 
                                alert(TEXT_CONTENT.shareFailed.zh + '\n' + TEXT_CONTENT.shareFailed.en);
                            }
                        }
                    } else {
                        console.warn("Web Share API Level 2 (files) not supported or cannot share files.");
                        alert(TEXT_CONTENT.shareUnsupported.zh + '\n' + TEXT_CONTENT.shareUnsupported.en);
                    }
                }, 'image/png');

            } catch (error) { 
                console.error("Error during certificate preparation or html2canvas:", error);
                alert(TEXT_CONTENT.shareHtml2CanvasError.zh + '\n' + TEXT_CONTENT.shareHtml2CanvasError.en);
            } finally {
                if (tempWrapper && tempWrapper.parentNode) {
                    tempWrapper.parentNode.removeChild(tempWrapper);
                    console.log("Temporary share wrapper removed from DOM.");
                }
            }
        }


        // --- Drag and Drop Event Listeners ---
        currentPictureElement.addEventListener('dragstart', (e) => {
            const targetElement = currentPictureElement;
            const dataOwnerValue = targetElement.getAttribute('data-owner');
            if (targetElement.draggable && dataOwnerValue) {
                e.dataTransfer.setData('text/plain', dataOwnerValue);
                setTimeout(() => { targetElement.style.opacity = '0.5'; }, 0);
            } else {
                e.preventDefault();
            }
        });

        currentPictureElement.addEventListener('dragend', (e) => {
             if (!e.dataTransfer || e.dataTransfer.dropEffect === 'none') {
                 e.target.style.opacity = '1';
             }
        });

        [groomColumn, brideColumn].forEach(column => {
            column.addEventListener('dragover', (e) => {
                e.preventDefault();
                column.classList.add('drag-over');
            });
            column.addEventListener('dragleave', () => {
                column.classList.remove('drag-over');
            });
            column.addEventListener('drop', (e) => {
                e.preventDefault();
                column.classList.remove('drag-over');
                const draggedOwner = e.dataTransfer.getData('text/plain');
                const targetOwner = column.dataset.owner;
                if (draggedOwner) {
                    handleDrop(currentPictureElement, column, draggedOwner, targetOwner);
                }
            });
        });

        currentPictureElement.addEventListener('touchstart', (e) => {
            const targetElement = currentPictureElement;
            if (targetElement.draggable && targetElement.hasAttribute('data-owner')) {
                e.preventDefault(); 
                isDragging = true;
                targetElement.classList.add('dragging');
                const touch = e.touches[0];
                const rect = targetElement.getBoundingClientRect();
                dragOffsetX = touch.clientX - rect.left;
                dragOffsetY = touch.clientY - rect.top;
                targetElement.style.position = 'fixed';
                targetElement.style.left = `${touch.clientX - dragOffsetX}px`;
                targetElement.style.top = `${touch.clientY - dragOffsetY}px`;
            }
        }, { passive: false });

        currentPictureElement.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            e.preventDefault(); 
            const touch = e.touches[0];
            const newX = touch.clientX - dragOffsetX;
            const newY = touch.clientY - dragOffsetY;
            currentPictureElement.style.left = `${newX}px`;
            currentPictureElement.style.top = `${newY}px`;
            highlightDropTarget(touch.clientX, touch.clientY);
        }, { passive: false });

        currentPictureElement.addEventListener('touchend', (e) => {
            if (!isDragging) return;
            isDragging = false;
            currentPictureElement.classList.remove('dragging');
            currentPictureElement.style.left = 'auto';
            currentPictureElement.style.top = 'auto';
            currentPictureElement.style.opacity = '1'; 

            const touch = e.changedTouches[0];
            const dropTarget = getDropTarget(touch.clientX, touch.clientY);
            [groomColumn, brideColumn].forEach(column => column.classList.remove('drag-over'));

            if (dropTarget) {
                const draggedOwner = currentPictureElement.getAttribute('data-owner');
                const targetOwner = dropTarget.dataset.owner;
                handleDrop(currentPictureElement, dropTarget, draggedOwner, targetOwner);
            } else {
                currentPictureElement.style.position = 'relative';
            }
        });

        function getDropTarget(x, y) {
            let target = null;
            const originalVisibility = currentPictureElement.style.visibility;
            if (isDragging) currentPictureElement.style.visibility = 'hidden';
            const elementUnderTouch = document.elementFromPoint(x, y);
            if (isDragging) currentPictureElement.style.visibility = originalVisibility; 

            if (elementUnderTouch) {
                target = elementUnderTouch.closest('.drop-column');
            }
            return target;
        }

        function highlightDropTarget(x, y) {
             [groomColumn, brideColumn].forEach(column => column.classList.remove('drag-over'));
             const dropTarget = getDropTarget(x, y);
             if (dropTarget) {
                 dropTarget.classList.add('drag-over');
             }
        }

        // --- Initial Setup and Page Transitions ---
       async function setupAndStartGame() {
            score = 0;
            currentPictureIndex = 0;
            gamePictures = [];
            startTime = null;
            secondsElapsed = 0;
            document.querySelectorAll('.dropped-item').forEach(item => item.remove());
            if(emailStatusEl) emailStatusEl.innerHTML = '';
            startError.innerHTML = '';
            startGameButton.disabled = false;
           
           if (allPictures.length === 0) {
                await fetchPhotoManifests(BRIDE_MANIFEST_URL, GROOM_MANIFEST_URL);
                if (allPictures.length === 0) return; // Stop if photos still couldn't load
            }
            gamePictures = selectRandomPictures(allPictures, picturesPerGame);
            if (gamePictures.length === 0) {
                startError.innerHTML = `<span class="lang-zh">錯誤：無法載入圖片。</span><span class="lang-en">Error: Could not load pictures.</span>`;
                return;
            }
            showPage('game-screen');
            replayButton.classList.add('hidden');
            updateItemsLeft();
            loadNextPicture();
            startTimer();
        }

        function validateAndInitGame() {
            userNickname = nicknameInput.value.trim();
            userEmail = emailInput.value.trim();
            startError.innerHTML = '';

            if (!userNickname || !userEmail) {
                startError.innerHTML = `<span class="lang-zh">${TEXT_CONTENT.errorEnterDetails.zh}</span><span class="lang-en">${TEXT_CONTENT.errorEnterDetails.en}</span>`;
                return;
            }
            if (!/\S+@\S+\.\S+/.test(userEmail)) { // Basic email validation
                 startError.innerHTML = `<span class="lang-zh">${TEXT_CONTENT.errorInvalidEmail.zh}</span><span class="lang-en">${TEXT_CONTENT.errorInvalidEmail.en}</span>`;
                 return;
            }
            setupAndStartGame();
        }

        function replayGame() {
             if (userNickname && userEmail) { // Ensure user details are still available
                 setupAndStartGame();
             } else {
                 showPage('start-screen'); // If not, go back to input details
             }
        }

        // --- Event Listeners ---
        continueButton.addEventListener('click', () => showPage('start-screen'));
        startGameButton.addEventListener('click', validateAndInitGame);
        replayButton.addEventListener('click', replayGame);
        instagramShareLink.addEventListener('click', (e) => {
            e.preventDefault();
            shareCertificate();
        });
        
        // --- Initial Display ---
        showPage('welcome-screen');
        fetchPhotoManifests(BRIDE_MANIFEST_URL, GROOM_MANIFEST_URL);
        
        if (EMAILJS_PUBLIC_KEY && EMAILJS_PUBLIC_KEY !== 'YOUR_PUBLIC_KEY') {
            try { emailjs.init(EMAILJS_PUBLIC_KEY); } catch(e) { console.error("EmailJS Init failed:", e); }
        } else {
            console.warn("EmailJS Public Key not set. Email sending will be disabled.");
        }
    </script>
</body>
</html>
